"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.userController = void 0;
const user_model_1 = require("./user.model");
const plan_model_1 = require("../plans/plan.model");
const bcryptjs_1 = __importDefault(require("bcryptjs"));
const google_auth_library_1 = require("google-auth-library");
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const referral_1 = require("../utils/referral");
const email_service_1 = require("../utils/email.service");
const email_templates_1 = require("../utils/email-templates");
const ledger_model_1 = require("../ledgers/ledger.model");
const JWT_SECRET = process.env.JWT_SECRET || "your-secret-key-change-in-production";
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || "7d";
const client = new google_auth_library_1.OAuth2Client(process.env.GOOGLE_CLIENT_ID);
exports.userController = {
    // Get all users
    getAllUsers: async (req, res) => {
        try {
            const users = await user_model_1.User.findAll({
                attributes: { exclude: ["passwordHash"] },
                include: [
                    {
                        model: plan_model_1.Plan,
                        as: "plan",
                        attributes: ["id", "name", "price", "credits"],
                    },
                ],
            });
            res.json(users);
        }
        catch (error) {
            res.status(500).json({ error: error.message });
        }
    },
    // Get user by ID
    getUserById: async (req, res) => {
        try {
            const user = await user_model_1.User.findByPk(req.params.id, {
                attributes: { exclude: ["passwordHash"] },
                include: [
                    {
                        model: plan_model_1.Plan,
                        as: "plan",
                        attributes: ["id", "name", "price", "credits"],
                    },
                ],
            });
            if (!user) {
                return res.status(404).json({ error: "User not found" });
            }
            res.json(user);
        }
        catch (error) {
            res.status(500).json({ error: error.message });
        }
    },
    // Create new user
    createUser: async (req, res) => {
        try {
            const { email, password, googleId, fullName, planId } = req.body;
            // Hash password if provided
            let passwordHash;
            if (password) {
                passwordHash = await bcryptjs_1.default.hash(password, 10);
            }
            const user = await user_model_1.User.create({
                email,
                passwordHash,
                googleId,
                fullName,
                planId,
                // referralCode will be auto-generated by beforeCreate hook
            });
            const userResponse = user.toJSON();
            delete userResponse.passwordHash;
            res.status(201).json(userResponse);
        }
        catch (error) {
            res.status(400).json({ error: error.message });
        }
    },
    // Update user
    updateUser: async (req, res) => {
        try {
            const updates = req.body;
            // Don't allow direct password updates
            if (updates.password) {
                delete updates.password;
            }
            const user = await user_model_1.User.findByPk(req.params.id);
            if (!user) {
                return res.status(404).json({ error: "User not found" });
            }
            await user.update(updates);
            const userResponse = user.toJSON();
            delete userResponse.passwordHash;
            res.json(userResponse);
        }
        catch (error) {
            res.status(400).json({ error: error.message });
        }
    },
    // Delete user
    deleteUser: async (req, res) => {
        try {
            const user = await user_model_1.User.findByPk(req.params.id);
            if (!user) {
                return res.status(404).json({ error: "User not found" });
            }
            await user.destroy();
            res.json({ message: "User deleted successfully" });
        }
        catch (error) {
            res.status(500).json({ error: error.message });
        }
    },
    // Get user credit balance
    getCreditBalance: async (req, res) => {
        try {
            const user = await user_model_1.User.findByPk(req.params.id, {
                attributes: ["creditBalance"],
            });
            if (!user) {
                return res.status(404).json({ error: "User not found" });
            }
            res.json({ creditBalance: user.creditBalance });
        }
        catch (error) {
            res.status(500).json({ error: error.message });
        }
    },
    // Google OAuth authentication
    googleAuth: async (req, res) => {
        try {
            const { token: googleToken, plan, referralCode } = req.body;
            console.log("Received Google Auth Request:", {
                plan,
                referralCode: referralCode ? "***" : "none",
                tokenHeader: googleToken.substring(0, 10),
            });
            const ticket = await client.verifyIdToken({
                idToken: googleToken,
                audience: process.env.GOOGLE_CLIENT_ID || "",
            });
            const payload = ticket.getPayload();
            if (!payload || !payload.email) {
                return res.status(401).json({ message: "Invalid Google Token" });
            }
            console.log("Google Token Payload:", payload);
            const email = payload.email;
            const firstName = payload.given_name || "";
            const lastName = payload.family_name || "";
            const fullName = `${firstName} ${lastName}`.trim();
            const image = payload.picture || "";
            let user = await user_model_1.User.findOne({ where: { email } });
            let isNewUser = false;
            let referrer = null;
            if (!user) {
                isNewUser = true;
                // Create new user with Google auth
                const passwordHash = await bcryptjs_1.default.hash("GOOGLE_AUTH_USER_" + Math.random().toString(36), 10);
                let creditBalance = 8; // Base welcome bonus
                let referredById;
                // Validate and process referral code if provided
                if (referralCode) {
                    referrer = await (0, referral_1.validateReferralCode)(referralCode);
                    if (referrer) {
                        referredById = referrer.id;
                        creditBalance = 18; // 8 base + 10 referral bonus
                    }
                    else {
                        console.warn(`Invalid referral code provided: ${referralCode} for user ${email}`);
                        // Continue without referral if code is invalid
                    }
                }
                user = await user_model_1.User.create({
                    email,
                    fullName,
                    image,
                    passwordHash,
                    googleId: payload.sub,
                    creditBalance,
                    referredById,
                    // referralCode will be auto-generated by beforeCreate hook
                });
                console.log(`New user created: ${user.email}, referralCode: ${user.referralCode}`);
                // If user came from referral, add ledger entries and send emails
                if (referrer && referredById) {
                    try {
                        // Add referral bonus credits to new user via ledger
                        await ledger_model_1.Ledger.create({
                            userId: user.id,
                            type: ledger_model_1.TransactionType.CREDIT,
                            amount: 10,
                            balanceAfter: creditBalance,
                            referenceModel: "Referral",
                            description: "Referral signup bonus",
                        });
                        // Add referral reward credits to referrer via ledger
                        const referrerNewBalance = (referrer.creditBalance || 0) + 10;
                        await referrer.increment("creditBalance", { by: 10 });
                        await ledger_model_1.Ledger.create({
                            userId: referrer.id,
                            type: ledger_model_1.TransactionType.CREDIT,
                            amount: 10,
                            balanceAfter: referrerNewBalance,
                            referenceModel: "Referral",
                            description: `Referral reward - ${user.fullName || user.email} signed up`,
                        });
                        console.log(`Referral credits granted: ${user.email} +10, ${referrer.email} +10`);
                        // Send emails asynchronously (non-blocking)
                        const emailsToSend = [
                            {
                                to: user.email,
                                ...(0, email_templates_1.referralSignupWelcomeEmail)(user.fullName || "", referrer.fullName || ""),
                            },
                            {
                                to: referrer.email,
                                ...(0, email_templates_1.referralRewardEmail)(referrer.fullName || "", user.fullName || ""),
                            },
                        ];
                        (0, email_service_1.sendEmails)(emailsToSend).catch((err) => {
                            console.error("Error sending referral emails:", err);
                        });
                    }
                    catch (ledgerError) {
                        console.error("Error processing referral credits:", ledgerError);
                        // Don't fail the signup if ledger/email fails
                    }
                }
            }
            else {
                // Update existing user
                const updates = {};
                if (!user.fullName && fullName)
                    updates.fullName = fullName;
                if (!user.googleId && payload.sub)
                    updates.googleId = payload.sub;
                if (image)
                    updates.image = image;
                // Never update referralCode or referredById for existing users
                if (Object.keys(updates).length > 0) {
                    await user.update(updates);
                }
                console.log(`Existing user updated: ${user.email}`);
            }
            const userResponse = user.toJSON();
            delete userResponse.passwordHash;
            // Generate JWT token
            const signOptions = { expiresIn: JWT_EXPIRES_IN };
            const token = jsonwebtoken_1.default.sign({
                id: user.id.toString(),
                email: user.email,
                fullName: user.fullName,
                role: "user",
            }, JWT_SECRET, signOptions);
            res.json({ user: userResponse, token });
        }
        catch (error) {
            console.error("Google Auth Error:", error);
            res.status(401).json({
                message: "Invalid Google Token",
                error: error.toString(),
            });
        }
    },
    // Get current user profile (renamed from verify-payment)
    getCurrentUser: async (req, res) => {
        try {
            // Extract email from JWT token (set by verifyUserToken middleware)
            const email = req.user?.email;
            if (!email) {
                return res.status(401).json({ message: "Authentication required" });
            }
            const user = await user_model_1.User.findOne({
                where: { email },
                attributes: { exclude: ["passwordHash"] },
                include: [
                    {
                        model: plan_model_1.Plan,
                        as: "plan",
                        attributes: ["id", "name", "price", "credits"],
                    },
                ],
            });
            if (!user) {
                return res.status(404).json({ message: "User not found" });
            }
            res.json({ user });
        }
        catch (error) {
            res.status(500).json({ message: "Server error", error: error.message });
        }
    },
    // Test email sending (for development/testing only)
    sendTestEmail: async (req, res) => {
        try {
            const { email, newUserName, referrerName, emailType } = req.body;
            // Validate required fields
            if (!email) {
                return res.status(400).json({ error: "Email address is required" });
            }
            if (!newUserName || !referrerName) {
                return res
                    .status(400)
                    .json({ error: "newUserName and referrerName are required" });
            }
            if (!emailType || !["welcome", "reward"].includes(emailType)) {
                return res.status(400).json({
                    error: 'emailType must be either "welcome" or "reward"',
                });
            }
            console.log("ðŸ“§ Sending test email:", {
                email,
                emailType,
                newUserName,
                referrerName,
            });
            if (emailType === "welcome") {
                const template = (0, email_templates_1.referralSignupWelcomeEmail)(newUserName, referrerName);
                await (0, email_service_1.sendEmails)([
                    {
                        to: email,
                        subject: template.subject,
                        htmlContent: template.htmlContent,
                        textContent: template.textContent,
                    },
                ]);
            }
            else if (emailType === "reward") {
                const template = (0, email_templates_1.referralRewardEmail)(referrerName, newUserName);
                await (0, email_service_1.sendEmails)([
                    {
                        to: email,
                        subject: template.subject,
                        htmlContent: template.htmlContent,
                        textContent: template.textContent,
                    },
                ]);
            }
            res.json({
                message: `Test ${emailType} email sent successfully to ${email}`,
                email,
                emailType,
            });
        }
        catch (error) {
            console.error("Error sending test email:", error);
            res.status(500).json({
                error: "Failed to send test email",
                details: error.message,
            });
        }
    },
};
//# sourceMappingURL=user.controller.js.map